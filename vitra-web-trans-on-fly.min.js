let db;const API="https://ontheflyapi.vitra.ai";class Vitra{apiKey=null;textList=[];constructor(t=null){this.apiKey=t}async initialize({api_key:t}){this.apiKey=t,await localStorage.setItem("apiKey",t);try{let e=await (await fetch(`${API}/project/get-translation?apiKey=${t}`,{method:"GET"})).json();if(console.log("data",e),!1===e.success&&!0===e.invalidRequest){console.log("INVALID API KEY");return}{this.insertDropdown(e.sourceLanguage,e.languages),await this.configureDB(e.languages);let a={};e.success?(console.log(e.translation),a=e.translation):(console.log(e.message),a=await this.translateAllInitially(e.languages)),console.log("translatedData",a),await this.saveToDBInitially(a)}}catch(l){console.log(l)}}async configureDB(t){let e={};t.forEach(t=>{e[t]="originText, translatedText"}),await (db=new Dexie("TranslationDB")).version(1).stores(e),console.log("DB Configured")}insertDropdown(t,e){let a=document.createElement("select"),l=document.createElement("option");l.text=t.toUpperCase(),l.value=null,l.setAttribute("selected","selected"),a.appendChild(l),e.forEach(t=>{let e=document.createElement("option");e.value=t,e.text=t.toUpperCase(),a.appendChild(e)}),a.setAttribute("id","lang-select"),a.style.position="fixed",a.style.width="170px",a.style.bottom="20px",a.style.left="40px",a.style["border-radius"]="50px",a.style["text-align"]="center",a.style["box-shadow"]="2px 2px 3px #999",document.body.appendChild(a);let n=document.getElementById("lang-select");n.addEventListener("change",()=>{console.log("Lang Changed",n.value);let t=n.value;var e=window.location.href;null!==t?e.indexOf("lang=")>-1?e=e.replace(/lang=[a-z]+/g,`lang=${t}`):e.indexOf("?")>-1?e+=`&lang=${t}`:e+=`?lang=${t}`:e=e.replace(/lang=[a-z]+/g,""),window.location.href=e})}async saveToDBInitially(t){let e=Object.keys(t);for(let a=0;a<e.length;a++){let l=e[a],n=t[l],i=Object.keys(n);for(let s=0;s<i.length;s++){let r=i[s],o=n[r],g=await db[l].where({originText:r}).first();g?await db[l].update(r,{translatedText:o}):await db[l].add({originText:r,translatedText:o})}}}getAllText(t){if("SCRIPT"===t.tagName||"STYLE"===t.tagName||"NOSCRIPT"===t.tagName||"svg"===t.tagName||"lang-select"===t.id)return null;if(3===t.nodeType&&0!==t.nodeValue.trim().length){let e=t.nodeValue;this.textList.push(e)}let a=t.childNodes;for(let l=0;l<a.length;l++)this.getAllText(a[l])}async translateAllInitially(t){let e=document.body.childNodes;for(let a=0;a<e.length;a++)this.getAllText(e[a]);try{let l=await (await fetch(`${API}/project/translate-all`,{method:"POST",headers:{Accept:"*/*","Content-Type":"application/json"},body:JSON.stringify({apiKey:this.apiKey,sourceTextData:this.textList,targetLanguage:t[0]})})).json();if(l.success)return console.log(l.translation),l.translation;return{}}catch(n){console.log(n)}}async translateText(t,e){try{let a=await db[e].where({originText:t}).first();if(a)return a.translatedText;{if(0===t.trim().length)return t;let l=await (await fetch(`${API}/project/translate-text`,{method:"POST",headers:{Accept:"*/*","Content-Type":"application/json"},body:JSON.stringify({apiKey:this.apiKey,sourceText:t,targetLanguage:e})})).json();if(!0!==l.success)return t;{let n=await db[e].where({originText:t}).first();return n?(console.log("ALREADY TRANSLATED2",n.originText),await db[e].update(t,{translatedText:l.translation})):(console.log("TRANSLATING2",t),await db[e].add({originText:t,translatedText:l.translation})),l.translation}}}catch(i){console.log(i)}}async translateElement(t,e){if("SCRIPT"===t.tagName||"STYLE"===t.tagName||"NOSCRIPT"===t.tagName||"svg"===t.tagName||"lang-select"===t.id)return;if(3===t.nodeType&&0!==t.nodeValue.trim().length){console.log(t.nodeValue);let a=await this.translateText(t.nodeValue,e);t.nodeValue=a}let l=t.childNodes;for(let n=0;n<l.length;n++)this.translateElement(l[n],e)}}const delay=t=>new Promise(e=>setTimeout(e,t));document.onreadystatechange=()=>{if(console.log("readyState",document.readyState),"complete"===document.readyState){let t=new URLSearchParams(location.search),e=t.get("lang"),a=localStorage.getItem("apiKey"),l=new Vitra(a);null!==e&&(async()=>{await delay(500);let t=document.getElementById("lang-select");t.value=e;let a=document.body.childNodes;for(let n=0;n<a.length;n++)l.translateElement(a[n],e)})()}};